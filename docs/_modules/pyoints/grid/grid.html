
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyoints.grid.grid &#8212; Pyoints version 0.2.0rc1 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Pyoints version 0.2.0rc1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyoints.grid.grid</h1><div class="highlight"><pre>
<span></span><span class="c1"># BEGIN OF LICENSE NOTE</span>
<span class="c1"># This file is part of Pyoints.</span>
<span class="c1"># Copyright (c) 2018, Sebastian Lamprecht, Trier University,</span>
<span class="c1"># lamprecht@uni-trier.de</span>
<span class="c1">#</span>
<span class="c1"># Pyoints is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># Pyoints is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with Pyoints. If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="c1"># END OF LICENSE NOTE</span>
<span class="sd">&quot;&quot;&quot;Handling of grided data like voxels or rasters.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">assertion</span><span class="p">,</span>
    <span class="n">nptools</span><span class="p">,</span>
    <span class="n">projection</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="n">georecords</span> <span class="kn">import</span> <span class="nn">GeoRecords</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="n">extent</span> <span class="kn">import</span> <span class="nn">Extent</span>
<span class="kn">from</span> <span class="nn">.transformation</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">keys_to_coords</span><span class="p">,</span>
    <span class="n">coords_to_keys</span><span class="p">,</span>
    <span class="n">coords_to_coords</span><span class="p">,</span>
    <span class="n">keys_to_indices</span><span class="p">,</span>
    <span class="n">indices_to_keys</span><span class="p">,</span>
    <span class="n">corners_to_transform</span><span class="p">,</span>
    <span class="n">transform_to_corners</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..misc</span> <span class="k">import</span> <span class="n">print_rounded</span>


<div class="viewcode-block" id="Grid"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid">[docs]</a><span class="k">class</span> <span class="nc">Grid</span><span class="p">(</span><span class="n">GeoRecords</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Grid class extends GeoRecords to ease handling of matrices like rasters</span>
<span class="sd">    or voxels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    proj : pyoints.projection.Proj</span>
<span class="sd">        Projection object provides the geograpic projection of the grid.</span>
<span class="sd">    rec : np.recarray</span>
<span class="sd">        Multidimensional array of objects. Each cell of the matrix represents a</span>
<span class="sd">        geo-object with `k` dimensional coordinates.</span>
<span class="sd">    T : array_like(Number, shape=(k+1, k+1))</span>
<span class="sd">        A linear transformation matrix to transform the coordinates. The</span>
<span class="sd">        translation represents the origin, the rotation represents the</span>
<span class="sd">        orientation, and the scale represents the pixel size of the matrix.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from pyoints import (</span>
<span class="sd">    ...     transformation,</span>
<span class="sd">    ...     projection,</span>
<span class="sd">    ... )</span>

<span class="sd">    Create a raster with a projection and a transformation matrix.</span>

<span class="sd">    &gt;&gt;&gt; proj = projection.Proj()</span>
<span class="sd">    &gt;&gt;&gt; data = np.recarray((4, 3), dtype=[(&#39;values&#39;, int)])</span>
<span class="sd">    &gt;&gt;&gt; data[&#39;values&#39;] = np.arange(np.product(data.shape)).reshape(data.shape)</span>
<span class="sd">    &gt;&gt;&gt; T = transformation.matrix(t=[10, 20], s=[0.5, 0.4], order=&#39;rst&#39;)</span>

<span class="sd">    &gt;&gt;&gt; raster = Grid(proj, data, T)</span>
<span class="sd">    &gt;&gt;&gt; print(raster.dtype.descr)</span>
<span class="sd">    [(&#39;values&#39;, &#39;&lt;i8&#39;), (&#39;coords&#39;, &#39;&lt;f8&#39;, (2,))]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(raster.shape)</span>
<span class="sd">    (4, 3)</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(raster.dim)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(raster.t.origin)</span>
<span class="sd">    [ 10.  20.]</span>

<span class="sd">    Get cell data of the raster.</span>

<span class="sd">    &gt;&gt;&gt; print_rounded(raster.coords)</span>
<span class="sd">    [[[ 10.25  20.2 ]</span>
<span class="sd">      [ 10.75  20.2 ]</span>
<span class="sd">      [ 11.25  20.2 ]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[ 10.25  20.6 ]</span>
<span class="sd">      [ 10.75  20.6 ]</span>
<span class="sd">      [ 11.25  20.6 ]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[ 10.25  21.  ]</span>
<span class="sd">      [ 10.75  21.  ]</span>
<span class="sd">      [ 11.25  21.  ]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[ 10.25  21.4 ]</span>
<span class="sd">      [ 10.75  21.4 ]</span>
<span class="sd">      [ 11.25  21.4 ]]]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(raster.values)</span>
<span class="sd">    [[ 0  1  2]</span>
<span class="sd">     [ 3  4  5]</span>
<span class="sd">     [ 6  7  8]</span>
<span class="sd">     [ 9 10 11]]</span>

<span class="sd">    Convert coordinates to indices and reverse.</span>

<span class="sd">    &gt;&gt;&gt; print_rounded(raster.coords_to_keys(raster.t.origin))</span>
<span class="sd">    [0 0]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(raster.keys_to_coords([-0.5, -0.5]))</span>
<span class="sd">    [ 10.  20.]</span>

<span class="sd">    &gt;&gt;&gt; print_rounded(raster.coords_to_keys(raster.coords))</span>
<span class="sd">    [[[0 0]</span>
<span class="sd">      [0 1]</span>
<span class="sd">      [0 2]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[1 0]</span>
<span class="sd">      [1 1]</span>
<span class="sd">      [1 2]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[2 0]</span>
<span class="sd">      [2 1]</span>
<span class="sd">      [2 2]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[3 0]</span>
<span class="sd">      [3 1]</span>
<span class="sd">      [3 2]]]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(raster.keys_to_coords(raster.keys))</span>
<span class="sd">    [[[ 10.25  20.2 ]</span>
<span class="sd">      [ 10.75  20.2 ]</span>
<span class="sd">      [ 11.25  20.2 ]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[ 10.25  20.6 ]</span>
<span class="sd">      [ 10.75  20.6 ]</span>
<span class="sd">      [ 11.25  20.6 ]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[ 10.25  21.  ]</span>
<span class="sd">      [ 10.75  21.  ]</span>
<span class="sd">      [ 11.25  21.  ]]</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">     [[ 10.25  21.4 ]</span>
<span class="sd">      [ 10.75  21.4 ]</span>
<span class="sd">      [ 11.25  21.4 ]]]</span>

<span class="sd">    Usage of the spatial index.</span>

<span class="sd">    &gt;&gt;&gt; dists, indices = raster.indexKD().knn(raster.t.origin, k=5)</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(dists)</span>
<span class="sd">    [ 0.32  0.65  0.78  0.96  1.03]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(indices)</span>
<span class="sd">    [0 3 1 4 6]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(raster.indices_to_keys(indices))</span>
<span class="sd">    [[0 0]</span>
<span class="sd">     [1 0]</span>
<span class="sd">     [0 1]</span>
<span class="sd">     [1 1]</span>
<span class="sd">     [2 0]]</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    GeoRecords</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">projection</span><span class="o">.</span><span class="n">Proj</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;&#39;proj&#39; needs to be of type &#39;Proj&#39;, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;numpy record array required, got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;at least two dimensions required&#39;</span><span class="p">)</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">assertion</span><span class="o">.</span><span class="n">ensure_tmatrix</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">nptools</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">keys_to_coords</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">shape</span><span class="p">))]</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">nptools</span><span class="o">.</span><span class="n">add_fields</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">coords</span><span class="p">])</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">GeoRecords</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

<div class="viewcode-block" id="Grid.from_corners"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.from_corners">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_corners</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternative constructor using grid corners.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        proj : pyoints.projection.Proj</span>
<span class="sd">            Projection object provides the geographic projection of the grid.</span>
<span class="sd">        corners : array_like(Number, shape=(n, k))</span>
<span class="sd">            Desired `k` dimensional corners of the grid.</span>
<span class="sd">        scale : array_like(int, shape=(k))</span>
<span class="sd">            Desired scale of the pixel cells.</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        Grid.from_extent</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Derive a raster form corners with a positive scale.</span>

<span class="sd">        &gt;&gt;&gt; corners = [(1, 2), (4, 2), (4, 10), (1, 10)]</span>
<span class="sd">        &gt;&gt;&gt; scale = [1, 2]</span>
<span class="sd">        &gt;&gt;&gt; raster = Grid.from_corners(projection.Proj(), corners, scale)</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(raster.shape)</span>
<span class="sd">        (4, 3)</span>
<span class="sd">        &gt;&gt;&gt; print(sorted(raster.dtype.descr))</span>
<span class="sd">        [(&#39;coords&#39;, &#39;&lt;f8&#39;, (2,))]</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(raster.t)</span>
<span class="sd">        [[ 1.  0.  1.]</span>
<span class="sd">         [ 0.  2.  2.]</span>
<span class="sd">         [ 0.  0.  1.]]</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(raster.coords)</span>
<span class="sd">        [[[ 1.5  3. ]</span>
<span class="sd">          [ 2.5  3. ]</span>
<span class="sd">          [ 3.5  3. ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 1.5  5. ]</span>
<span class="sd">          [ 2.5  5. ]</span>
<span class="sd">          [ 3.5  5. ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 1.5  7. ]</span>
<span class="sd">          [ 2.5  7. ]</span>
<span class="sd">          [ 3.5  7. ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 1.5  9. ]</span>
<span class="sd">          [ 2.5  9. ]</span>
<span class="sd">          [ 3.5  9. ]]]</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(raster.corners)</span>
<span class="sd">        [[  1.   2.]</span>
<span class="sd">         [  4.   2.]</span>
<span class="sd">         [  4.  10.]</span>
<span class="sd">         [  1.  10.]]</span>
<span class="sd">        &gt;&gt;&gt; keys = raster.t.to_global(corners)</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(keys)</span>
<span class="sd">        [[ 0.  0.]</span>
<span class="sd">         [ 3.  0.]</span>
<span class="sd">         [ 3.  4.]</span>
<span class="sd">         [ 0.  4.]]</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(raster.t.to_local(keys))</span>
<span class="sd">        [[  1.   2.]</span>
<span class="sd">         [  4.   2.]</span>
<span class="sd">         [  4.  10.]</span>
<span class="sd">         [  1.  10.]]</span>

<span class="sd">        Example with inverted axes.</span>

<span class="sd">        &gt;&gt;&gt; from pyoints import transformation</span>

<span class="sd">        &gt;&gt;&gt; corners = [(1, 1), (3, 1), (3, 4), (1, 4)]</span>
<span class="sd">        &gt;&gt;&gt; raster = Grid.from_corners(projection.Proj(), corners, [-0.5, -1])</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(raster.shape)</span>
<span class="sd">        (3, 4)</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(raster.records().coords.min(0))</span>
<span class="sd">        [ 1.25  1.5 ]</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(raster.records().coords.max(0))</span>
<span class="sd">        [ 2.75  3.5 ]</span>

<span class="sd">        &gt;&gt;&gt; t, r, s, det = transformation.decomposition(raster.t)</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(t)</span>
<span class="sd">        [ 3.  4.]</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(s)</span>
<span class="sd">        [ 0.5  1. ]</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(raster.coords)</span>
<span class="sd">        [[[ 2.75  3.5 ]</span>
<span class="sd">          [ 2.25  3.5 ]</span>
<span class="sd">          [ 1.75  3.5 ]</span>
<span class="sd">          [ 1.25  3.5 ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 2.75  2.5 ]</span>
<span class="sd">          [ 2.25  2.5 ]</span>
<span class="sd">          [ 1.75  2.5 ]</span>
<span class="sd">          [ 1.25  2.5 ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 2.75  1.5 ]</span>
<span class="sd">          [ 2.25  1.5 ]</span>
<span class="sd">          [ 1.75  1.5 ]</span>
<span class="sd">          [ 1.25  1.5 ]]]</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(raster.corners)</span>
<span class="sd">        [[ 3.  4.]</span>
<span class="sd">         [ 1.  4.]</span>
<span class="sd">         [ 1.  1.]</span>
<span class="sd">         [ 3.  1.]]</span>
<span class="sd">        &gt;&gt;&gt; keys = raster.t.to_global(corners)</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(keys)</span>
<span class="sd">        [[ 4.  3.]</span>
<span class="sd">         [ 0.  3.]</span>
<span class="sd">         [ 0.  0.]</span>
<span class="sd">         [ 4.  0.]]</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(raster.t.to_local(keys))</span>
<span class="sd">        [[ 1.  1.]</span>
<span class="sd">         [ 3.  1.]</span>
<span class="sd">         [ 3.  4.]</span>
<span class="sd">         [ 1.  4.]]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">corners_to_transform</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">nptools</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">keys_to_coords</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;coords&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))])</span>
        <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span></div>

<div class="viewcode-block" id="Grid.from_extent"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.from_extent">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_extent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alternative constructor using grid corners.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        proj : pyoints.projection.Proj</span>
<span class="sd">            Projection object provides the geographic projection of the grid.</span>
<span class="sd">        ext : array_like(Number, shape=(2 * k)) or array_like(Number, shape=(n, k))</span>
<span class="sd">            Desired `k` dimensional extent of the gird. You can also specify</span>
<span class="sd">            the extent by providing coordinates.</span>
<span class="sd">        scale : array_like(int, shape=(k))</span>
<span class="sd">            Desired scale of the pixel cells.</span>

<span class="sd">        See also</span>
<span class="sd">        --------</span>
<span class="sd">        Grid.from_corners</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        Defining a raster using a two dimensional extent.</span>

<span class="sd">        &gt;&gt;&gt; extent = [1, 1, 3, 4]</span>
<span class="sd">        &gt;&gt;&gt; raster = Grid.from_extent(projection.Proj(), extent, [0.5, 1])</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(raster.shape)</span>
<span class="sd">        (3, 4)</span>
<span class="sd">        &gt;&gt;&gt; print(sorted(raster.dtype.descr))</span>
<span class="sd">        [(&#39;coords&#39;, &#39;&lt;f8&#39;, (2,))]</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(raster.coords)</span>
<span class="sd">        [[[ 1.25  1.5 ]</span>
<span class="sd">          [ 1.75  1.5 ]</span>
<span class="sd">          [ 2.25  1.5 ]</span>
<span class="sd">          [ 2.75  1.5 ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 1.25  2.5 ]</span>
<span class="sd">          [ 1.75  2.5 ]</span>
<span class="sd">          [ 2.25  2.5 ]</span>
<span class="sd">          [ 2.75  2.5 ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 1.25  3.5 ]</span>
<span class="sd">          [ 1.75  3.5 ]</span>
<span class="sd">          [ 2.25  3.5 ]</span>
<span class="sd">          [ 2.75  3.5 ]]]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corners</span> <span class="o">=</span> <span class="n">Extent</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span><span class="o">.</span><span class="n">corners</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_corners</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">transform_to_corners</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<div class="viewcode-block" id="Grid.transform"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transforms coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        T : array_like(Number, shape=(self.dim+1, self.dim+1))</span>
<span class="sd">            Transformation matrix to apply.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Overwrites `GeoRecords.transform`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        GeoRecords.transform</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">assertion</span><span class="o">.</span><span class="n">ensure_tmatrix</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys_to_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Grid.keys_to_indices"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.keys_to_indices">[docs]</a>    <span class="k">def</span> <span class="nf">keys_to_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts grid keys to indices.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        poynts.grid.keys_to_indices</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">keys_to_indices</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div>

<div class="viewcode-block" id="Grid.indices_to_keys"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.indices_to_keys">[docs]</a>    <span class="k">def</span> <span class="nf">indices_to_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts cell indices to keys.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        poynts.grid.indices_to_keys</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">indices_to_keys</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span></div>

<div class="viewcode-block" id="Grid.keys_to_coords"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.keys_to_coords">[docs]</a>    <span class="k">def</span> <span class="nf">keys_to_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts cell indices to coordinates.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        poynts.grid.keys_to_coords</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">keys_to_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span></div>

<div class="viewcode-block" id="Grid.coords_to_keys"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.coords_to_keys">[docs]</a>    <span class="k">def</span> <span class="nf">coords_to_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts coordinates to cell indices.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        poynts.grid.coords_to_keys</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">coords_to_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span></div>

<div class="viewcode-block" id="Grid.coords_to_coords"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.coords_to_coords">[docs]</a>    <span class="k">def</span> <span class="nf">coords_to_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets coordinate to closest grid coordinate.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        poynts.grid.coords_to_coords</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">coords_to_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span></div>

<div class="viewcode-block" id="Grid.window_by_extent"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.window_by_extent">[docs]</a>    <span class="k">def</span> <span class="nf">window_by_extent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gets a subset of the grid within a given extent.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        extent : Extent</span>
<span class="sd">            Extent defining the window corners.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Grid</span>
<span class="sd">            Desired subset.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pyoints import transformation</span>

<span class="sd">        Create Grid.</span>

<span class="sd">        &gt;&gt;&gt; T = transformation.matrix(s=(1, 2), t=[1, 0])</span>
<span class="sd">        &gt;&gt;&gt; proj = projection.Proj()</span>
<span class="sd">        &gt;&gt;&gt; grid = Grid(proj, np.recarray((4, 5), dtype=[]), T=T)</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(grid.extent())</span>
<span class="sd">        [ 1.5  1.   5.5  7. ]</span>

<span class="sd">        Select subset by extent.</span>

<span class="sd">        &gt;&gt;&gt; subset = grid.window_by_extent([3, 2, 7, 6])</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(subset.shape)</span>
<span class="sd">        (2, 3)</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(subset.coords)</span>
<span class="sd">        [[[ 3.5  3. ]</span>
<span class="sd">          [ 4.5  3. ]</span>
<span class="sd">          [ 5.5  3. ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 3.5  5. ]</span>
<span class="sd">          [ 4.5  5. ]</span>
<span class="sd">          [ 5.5  5. ]]]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">Extent</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_to_keys</span><span class="p">(</span><span class="n">extent</span><span class="o">.</span><span class="n">corners</span><span class="p">)</span>
        <span class="n">min_idx</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">min_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">max_idx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">slices</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Grid.voxelize"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.Grid.voxelize">[docs]</a>    <span class="k">def</span> <span class="nf">voxelize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a point cloud to a voxel or raster.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rec : np.recarray(shape=(n, ))</span>
<span class="sd">            Numpy record array of `n` points to voxelize. It requires the two</span>
<span class="sd">            dimensional field &#39;coords&#39; associated with `k` dimensional</span>
<span class="sd">            coordinates.</span>
<span class="sd">        \*\*kwargs</span>
<span class="sd">            Arguments passed to voxelize.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        voxelize</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; from pyoints import (</span>
<span class="sd">        ...     transformation,</span>
<span class="sd">        ...     projection,</span>
<span class="sd">        ... )</span>

<span class="sd">        Create Grid.</span>

<span class="sd">        &gt;&gt;&gt; T = transformation.matrix(s=(2.5, 3), t=[1, 0])</span>
<span class="sd">        &gt;&gt;&gt; dtype = [(&#39;points&#39;, np.recarray)]</span>
<span class="sd">        &gt;&gt;&gt; proj = projection.Proj()</span>
<span class="sd">        &gt;&gt;&gt; grid = Grid(proj, np.recarray((3, 4), dtype=dtype), T=T)</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(grid.shape)</span>
<span class="sd">        (3, 4)</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(grid.coords)</span>
<span class="sd">        [[[ 2.25  1.5 ]</span>
<span class="sd">          [ 4.75  1.5 ]</span>
<span class="sd">          [ 7.25  1.5 ]</span>
<span class="sd">          [ 9.75  1.5 ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 2.25  4.5 ]</span>
<span class="sd">          [ 4.75  4.5 ]</span>
<span class="sd">          [ 7.25  4.5 ]</span>
<span class="sd">          [ 9.75  4.5 ]]</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">         [[ 2.25  7.5 ]</span>
<span class="sd">          [ 4.75  7.5 ]</span>
<span class="sd">          [ 7.25  7.5 ]</span>
<span class="sd">          [ 9.75  7.5 ]]]</span>
<span class="sd">        &gt;&gt;&gt; print_rounded(grid.t.origin)</span>
<span class="sd">        [ 1.  0.]</span>

<span class="sd">        Create records to voxelize.</span>

<span class="sd">        &gt;&gt;&gt; coords = [(0, 0), (1, 0.5), (2, 2), (4, 6), (3, 2), (1, 5), (3, 5)]</span>
<span class="sd">        &gt;&gt;&gt; rec = np.recarray(len(coords), dtype=[(&#39;coords&#39;, float, 2)])</span>
<span class="sd">        &gt;&gt;&gt; rec[&#39;coords&#39;] = coords</span>

<span class="sd">        Voxelize the records and update the raster.</span>

<span class="sd">        &gt;&gt;&gt; voxels = grid.voxelize(rec)</span>
<span class="sd">        &gt;&gt;&gt; grid[&#39;points&#39;] = voxels</span>

<span class="sd">        &gt;&gt;&gt; print_rounded(grid[&#39;points&#39;][0, 0].coords)</span>
<span class="sd">        [[ 0.   0. ]</span>
<span class="sd">         [ 1.   0.5]</span>
<span class="sd">         [ 2.   2. ]</span>
<span class="sd">         [ 3.   2. ]]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">voxelize</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="voxelize"><a class="viewcode-back" href="../../../pyoints.grid.html#pyoints.grid.grid.voxelize">[docs]</a><span class="k">def</span> <span class="nf">voxelize</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agg_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aggregates a point cloud to a voxel or raster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rec : np.recarray(shape=(n, )) or GeoRecords</span>
<span class="sd">        Numpy record array of `n` points to voxelize. It requires a two</span>
<span class="sd">        dimensional field &#39;coords&#39; associated with `k` dimensional coordinates.</span>
<span class="sd">    T : array_like(Number, shape=(m+1, m+1))</span>
<span class="sd">        Transformation matrix defining the `m &lt;= k` dimensional voxel system.</span>
<span class="sd">    shape : optional, array_like(int, shape=(m))</span>
<span class="sd">        Shape of the output voxel space. If None, `shape` is fit to</span>
<span class="sd">        `rec.coords`.</span>
<span class="sd">    agg_func : optional, callable</span>
<span class="sd">        Function to aggregate the record array. If None, `agg_func` set to</span>
<span class="sd">        `lambda ids: rec[ids]`.</span>
<span class="sd">    dtype : optional, np.dtype</span>
<span class="sd">        Output data type. If None, set to automatically.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray or np.recarray(dtype=dtype) or Grid</span>
<span class="sd">        Desired `m` dimensional matrix. If `rec` is an instance of `GeoRecords`</span>
<span class="sd">        and `dtype` has named fields, an instance of `Grid` is returned. If</span>
<span class="sd">        no point falls within `T`, None is returned.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Grid, np.apply_function</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from pyoints import transformation</span>

<span class="sd">    Create record array with coordinates.</span>

<span class="sd">    &gt;&gt;&gt; coords = [(0, 0), (1, 0.5), (2, 2), (4, 6), (3, 2), (1, 5), (3, 0)]</span>
<span class="sd">    &gt;&gt;&gt; rec = np.recarray(len(coords), dtype=[(&#39;coords&#39;, float, 2)])</span>
<span class="sd">    &gt;&gt;&gt; rec[&#39;coords&#39;] = coords</span>

<span class="sd">    Voxelize records.</span>

<span class="sd">    &gt;&gt;&gt; T = transformation.matrix(s=(2.5, 3), t=[0, 0])</span>
<span class="sd">    &gt;&gt;&gt; grid = voxelize(rec, T)</span>

<span class="sd">    &gt;&gt;&gt; print(grid.dtype)</span>
<span class="sd">    object</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(grid.shape)</span>
<span class="sd">    (3, 2)</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(grid[0, 0].coords)</span>
<span class="sd">    [[ 0.   0. ]</span>
<span class="sd">     [ 1.   0.5]</span>
<span class="sd">     [ 2.   2. ]]</span>

<span class="sd">    Voxelize with aggregation function.</span>

<span class="sd">    &gt;&gt;&gt; dtype = [(&#39;points&#39;, type(rec)), (&#39;count&#39;, int)]</span>
<span class="sd">    &gt;&gt;&gt; agg_func = lambda ids: (rec[ids], len(ids))</span>
<span class="sd">    &gt;&gt;&gt; grid = voxelize(rec, T, agg_func=agg_func, dtype=dtype)</span>

<span class="sd">    &gt;&gt;&gt; print(grid.dtype.descr)</span>
<span class="sd">    [(&#39;points&#39;, &#39;|O&#39;), (&#39;count&#39;, &#39;&lt;i8&#39;)]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(grid.shape)</span>
<span class="sd">    (3, 2)</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(grid.count)</span>
<span class="sd">    [[3 2]</span>
<span class="sd">     [1 0]</span>
<span class="sd">     [0 1]]</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(grid[0, 0].points.coords)</span>
<span class="sd">    [[ 0.   0. ]</span>
<span class="sd">     [ 1.   0.5]</span>
<span class="sd">     [ 2.   2. ]]</span>

<span class="sd">    Voxelize three dimensional coordinates to receive a two dimensional raster.</span>

<span class="sd">    &gt;&gt;&gt; coords = [(0, 0, 1), (-2, 0.3, 5), (2, 2, 3), (4, 6, 2), (3, 2, 1)]</span>
<span class="sd">    &gt;&gt;&gt; rec = np.recarray(len(coords), dtype=[(&#39;coords&#39;, float, 3)])</span>
<span class="sd">    &gt;&gt;&gt; rec[&#39;coords&#39;] = coords</span>

<span class="sd">    &gt;&gt;&gt; T = transformation.matrix(s=(2.5, 3), t=[0, 0])</span>
<span class="sd">    &gt;&gt;&gt; grid = voxelize(rec, T)</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(grid.shape)</span>
<span class="sd">    (3, 2)</span>
<span class="sd">    &gt;&gt;&gt; print_rounded(grid[0, 0].coords)</span>
<span class="sd">    [[ 0.   0.   1. ]</span>
<span class="sd">     [-2.   0.3  5. ]</span>
<span class="sd">     [ 2.   2.   3. ]]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;rec&#39; needs an instance of np.recarray&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;coords&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;rec&#39; requires field &#39;coords&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">agg_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">agg_func</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span> <span class="k">return</span> <span class="n">rec</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">agg_func</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;agg_func&#39; needs to be callable&quot;</span><span class="p">)</span>

    <span class="n">coords</span> <span class="o">=</span> <span class="n">assertion</span><span class="o">.</span><span class="n">ensure_coords</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="n">min_dim</span><span class="o">=</span><span class="n">T</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">coords_to_keys</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">coords</span><span class="p">[:,</span> <span class="p">:</span><span class="n">T</span><span class="o">.</span><span class="n">dim</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)[:</span><span class="n">T</span><span class="o">.</span><span class="n">dim</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">assertion</span><span class="o">.</span><span class="n">ensure_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">T</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># group keys</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="n">keys_to_indices</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">shape</span><span class="p">)})</span>
    <span class="n">groupDict</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">indices_to_keys</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">groupDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">shape</span><span class="p">)</span>

    <span class="c1"># cut by extent</span>
    <span class="n">min_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">max_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">keys</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">min_mask</span><span class="p">,</span> <span class="n">max_mask</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># create lookup array</span>
    <span class="n">lookup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">lookup</span><span class="o">.</span><span class="n">fill</span><span class="p">([])</span>

    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupDict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">lookup</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mask</span><span class="p">]</span>

    <span class="c1"># Aggregate per cell</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">nptools</span><span class="o">.</span><span class="n">apply_function</span><span class="p">(</span><span class="n">lookup</span><span class="p">,</span> <span class="n">agg_func</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="s2">&quot;aggregation failed, please check &#39;agg_func&#39; and &#39;dtype&#39;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">GeoRecords</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/logo_pyoints.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Pyoints version 0.2.0rc1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Sebastian Lamprecht.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>